<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 16px;
      color: #333;
      background: #f5f5f5;
    }
    h2 {
      font-size: 18px;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 13px;
      color: #888;
      margin-bottom: 16px;
    }
    .room-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 12px;
    }
    .room-table th {
      background: #4a90d9;
      color: #fff;
      padding: 10px 12px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
    }
    .room-table th:first-child { width: 70px; }
    .room-table th:last-child { width: 50px; }
    .room-table td {
      padding: 6px 12px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .room-table tr:last-child td { border-bottom: none; }
    .room-table input[type="number"] {
      width: 55px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      text-align: center;
    }
    .room-table input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .room-table input:focus {
      outline: none;
      border-color: #4a90d9;
      box-shadow: 0 0 0 2px rgba(74,144,217,0.2);
    }
    .btn-remove {
      background: none;
      border: none;
      color: #e74c3c;
      font-size: 18px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .btn-remove:hover { background: #fdecea; }
    .actions {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }
    .btn-add {
      background: #4a90d9;
      color: #fff;
    }
    .btn-add:hover { background: #357abd; }
    .btn-save {
      background: #27ae60;
      color: #fff;
    }
    .btn-save:hover { background: #219a52; }
    .status {
      padding: 10px 14px;
      border-radius: 6px;
      font-size: 13px;
      margin-top: 8px;
      display: none;
    }
    .status.success { display: block; background: #d4edda; color: #155724; }
    .status.error { display: block; background: #f8d7da; color: #721c24; }
    .hint {
      font-size: 12px;
      color: #999;
      margin-top: 8px;
      line-height: 1.5;
    }
    .empty {
      text-align: center;
      padding: 24px;
      color: #999;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>üè† Room Configuration</h2>
  <p class="subtitle">Configure rooms for the "Clean specific rooms" flow action. Check the Dreame app for segment IDs.</p>

  <table class="room-table" id="roomTable">
    <thead>
      <tr>
        <th>Segment ID</th>
        <th>Room Name</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="roomBody">
    </tbody>
  </table>

  <div class="actions">
    <button class="btn btn-add" id="btnAdd">+ Add Room</button>
    <button class="btn btn-save" id="btnSave">Save</button>
  </div>

  <div class="status" id="status"></div>

  <p class="hint">
    Segment IDs are the numbers shown on the map in the Dreame mobile app.
    These are used by the vacuum to identify which room to clean.
  </p>

  <script>
    // Get the Homey object
    function onHomeyReady(Homey) {
      const roomBody = document.getElementById('roomBody');
      const status = document.getElementById('status');
      let rooms = [];

      // Default rooms
      const DEFAULT_ROOMS = [
        { id: 1, name: 'Kitchen' },
        { id: 2, name: 'Dining Room' },
        { id: 3, name: 'Living Room' },
        { id: 4, name: 'Hallway' },
        { id: 5, name: 'Stairs' },
        { id: 6, name: 'Bathroom' },
        { id: 7, name: 'Study' },
        { id: 8, name: 'Closet' },
        { id: 9, name: 'Bathroom2' },
      ];

      function renderRooms() {
        roomBody.innerHTML = '';
        if (rooms.length === 0) {
          roomBody.innerHTML = '<tr><td colspan="3" class="empty">No rooms configured. Click "+ Add Room" to begin.</td></tr>';
          return;
        }
        rooms.forEach(function(room, index) {
          const tr = document.createElement('tr');
          tr.innerHTML =
            '<td><input type="number" min="1" max="99" value="' + room.id + '" data-index="' + index + '" data-field="id"></td>' +
            '<td><input type="text" value="' + (room.name || '').replace(/"/g, '&quot;') + '" data-index="' + index + '" data-field="name" placeholder="Room name"></td>' +
            '<td><button class="btn-remove" data-index="' + index + '" title="Remove">‚úï</button></td>';
          roomBody.appendChild(tr);
        });

        // Bind events
        roomBody.querySelectorAll('input').forEach(function(input) {
          input.addEventListener('change', function() {
            var idx = parseInt(this.dataset.index);
            var field = this.dataset.field;
            if (field === 'id') {
              rooms[idx].id = parseInt(this.value) || 1;
            } else {
              rooms[idx].name = this.value;
            }
          });
        });

        roomBody.querySelectorAll('.btn-remove').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var idx = parseInt(this.dataset.index);
            rooms.splice(idx, 1);
            renderRooms();
          });
        });
      }

      function showStatus(msg, type) {
        status.textContent = msg;
        status.className = 'status ' + type;
        setTimeout(function() { status.className = 'status'; }, 4000);
      }

      function getNextId() {
        if (rooms.length === 0) return 1;
        return Math.max.apply(null, rooms.map(function(r) { return r.id; })) + 1;
      }

      // Signal Homey we're ready FIRST, then load data
      Homey.ready();

      // Load settings
      Homey.get('rooms', function(err, data) {
        if (err || !data) {
          rooms = DEFAULT_ROOMS.slice();
        } else {
          try {
            rooms = typeof data === 'string' ? JSON.parse(data) : data;
            if (!Array.isArray(rooms)) rooms = DEFAULT_ROOMS.slice();
          } catch (e) {
            rooms = DEFAULT_ROOMS.slice();
          }
        }
        renderRooms();
      });

      // Add room
      document.getElementById('btnAdd').addEventListener('click', function() {
        rooms.push({ id: getNextId(), name: '' });
        renderRooms();
        // Focus the new name input
        var inputs = roomBody.querySelectorAll('input[data-field="name"]');
        if (inputs.length > 0) inputs[inputs.length - 1].focus();
      });

      // Save
      document.getElementById('btnSave').addEventListener('click', function() {
        // Validate
        for (var i = 0; i < rooms.length; i++) {
          if (!rooms[i].name || !rooms[i].name.trim()) {
            showStatus('Room #' + (i + 1) + ' needs a name.', 'error');
            return;
          }
          if (!rooms[i].id || rooms[i].id < 1) {
            showStatus('Room #' + (i + 1) + ' needs a valid segment ID (‚â• 1).', 'error');
            return;
          }
        }

        // Check for duplicate IDs
        var ids = rooms.map(function(r) { return r.id; });
        var unique = ids.filter(function(v, i, a) { return a.indexOf(v) === i; });
        if (ids.length !== unique.length) {
          showStatus('Duplicate segment IDs found. Each room must have a unique ID.', 'error');
          return;
        }

        // Sort by ID
        rooms.sort(function(a, b) { return a.id - b.id; });

        Homey.set('rooms', rooms, function(err) {
          if (err) {
            showStatus('Failed to save: ' + err.message, 'error');
          } else {
            showStatus('Saved ' + rooms.length + ' rooms successfully!', 'success');
            renderRooms();
          }
        });
      });
    }
  </script>
</body>
</html>
